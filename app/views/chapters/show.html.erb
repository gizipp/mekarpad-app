<% chapter_seo_tags(@chapter, @story) %>

<div class="chapter-reader">
  <div class="reader-header">
    <div class="story-info">
      <%= link_to @story.title, @story %>
      <span class="separator">›</span>
      <span>Chapter <%= @chapter.order %>: <%= @chapter.title %></span>
    </div>
    <div class="chapter-navigation">
      <% if @chapter.previous_chapter %>
        <%= link_to "← Previous", story_chapter_path(@story, @chapter.previous_chapter), class: "btn btn-nav" %>
      <% end %>
      <% if @chapter.next_chapter %>
        <%= link_to "Next →", story_chapter_path(@story, @chapter.next_chapter), class: "btn btn-nav" %>
      <% end %>
    </div>
  </div>

  <div class="chapter-content">
    <h1><%= @chapter.title %></h1>

    <div class="content-text">
      <%= simple_format(@chapter.content) %>
    </div>
  </div>

  <div class="chapter-footer">
    <div class="chapter-navigation">
      <% if @chapter.previous_chapter %>
        <%= link_to "← Previous Chapter", story_chapter_path(@story, @chapter.previous_chapter), class: "btn btn-nav" %>
      <% end %>
      <% if @chapter.next_chapter %>
        <%= link_to "Next Chapter →", story_chapter_path(@story, @chapter.next_chapter), class: "btn btn-nav" %>
      <% else %>
        <p class="end-message">End of current chapters. Check back for updates!</p>
      <% end %>
    </div>
    <%= link_to "Back to Story", @story, class: "btn btn-secondary" %>
  </div>

  <div class="comments-section">
    <h2>Comments</h2>

    <% if current_user %>
      <%= form_with model: [:chapter, Comment.new], url: chapter_comments_path(@chapter), local: true do |f| %>
        <div class="form-group">
          <%= f.text_area :content, placeholder: "Share your thoughts on this chapter...", rows: 3, class: "form-control" %>
        </div>
        <%= f.submit "Post Comment", class: "btn btn-primary" %>
      <% end %>
    <% end %>

    <div class="comments-list">
      <% @comments.each do |comment| %>
        <div class="comment">
          <div class="comment-header">
            <strong><%= comment.user.name %></strong>
            <span class="comment-date"><%= time_ago_in_words(comment.created_at) %> ago</span>
          </div>
          <p class="comment-content"><%= comment.content %></p>
          <% if current_user && comment.user == current_user %>
            <%= button_to "Delete", comment_path(comment), method: :delete, data: { confirm: "Are you sure?" }, class: "btn-small btn-danger" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
